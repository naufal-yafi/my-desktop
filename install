#!/usr/bin/env sh

set -o pipefail

TIMESTAMP=$(date '+%d-%m-%Y_%H.%M')
LOG_DIR="$(pwd)/log"
LOG_FILE="$LOG_DIR/$TIMESTAMP.log"
mkdir -p "$LOG_DIR"
SUMMARY_OK=0
SUMMARY_FAIL=0
FAILED_STEPS=""

RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
RESET="\033[0m"

log_info() {
  echo -e "${YELLOW}[INFO]${RESET} $1"
  echo "[INFO] $1" >> "$LOG_FILE"
}

log_ok() {
  echo -e "${GREEN}[ OK ]${RESET} $1"
  echo "[ OK ] $1" >> "$LOG_FILE"
}

log_fail() {
  echo -e "${RED}[FAIL]${RESET} $1"
  echo "[FAIL] $1" >> "$LOG_FILE"
}

detect_fedora_variant() {
  if [ ! -f /etc/os-release ]; then
    log_fail "/etc/os-release not found (cannot detect OS)"
    exit 1
  fi

  . /etc/os-release

  FEDORA_VARIANT="${VARIANT_ID:-unknown}"
  log_info "Detected Fedora variant: ${FEDORA_VARIANT}"
}

require_fedora_server() {
  if [ "$FEDORA_VARIANT" != "server" ]; then
    log_info "Skipping: this step is intended for Fedora Server only"
    log_info "Current system is: ${FEDORA_VARIANT}"
    log_fail "Aborting installation"
    exit 1
  fi
}

run() {
  local msg="$1"
  shift

  log_info "$msg"

  if "$@" 2>&1 | tee -a "$LOG_FILE"; then
    log_ok "$msg"
  else
    log_fail "$msg"
    SUMMARY_FAIL=$((SUMMARY_FAIL + 1))
    FAILED_STEPS="${FAILED_STEPS}\n- $msg"
    return 1
  fi

  SUMMARY_OK=$((SUMMARY_OK + 1))
}

is_installed() {
  rpm -q "$1" >/dev/null 2>&1
}

install_packages() {
  local msg="$1"
  shift
  local pkgs=()

  for pkg in "$@"; do
    if is_installed "$pkg"; then
      log_info "SKIP ===> Package already installed: $pkg"
    else
      pkgs+=("$pkg")
    fi
  done

  if [ "${#pkgs[@]}" -eq 0 ]; then
    log_ok "$msg (all packages already installed)"
    return 0
  fi

  run "$msg" sudo dnf install -y "${pkgs[@]}"
}

is_group_installed() {
  dnf group list --installed | grep -qi "$1"
}

is_service_enabled() {
  systemctl is-enabled "$1" >/dev/null 2>&1
}

is_service_active() {
  systemctl is-active "$1" >/dev/null 2>&1
}

is_repo_installed() {
  rpm -q "$1" >/dev/null 2>&1
}

rpm_fusion() {
  RPMF_FREE="rpmfusion-free-release"
  RPMF_NONFREE="rpmfusion-nonfree-release"

  if is_repo_installed "$RPMF_FREE" && is_repo_installed "$RPMF_NONFREE"; then
    log_info "SKIP ===> RPM Fusion (free & nonfree) already enabled"
  else
    run "Enable RPM Fusion (free & nonfree)" \
      sudo dnf install -y \
        https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
        https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
  fi
}

manager_bluetooth_network() {
  SERVICES="NetworkManager bluetooth"
  NEED_ENABLE=()

  for svc in $SERVICES; do
    if is_service_enabled "$svc" && is_service_active "$svc"; then
      log_info "SKIP ===> $svc already enabled & active"
    else
      NEED_ENABLE="$NEED_ENABLE $svc"
    fi
  done

  if [ -n "$NEED_ENABLE" ]; then
    run "Enable NetworkManager & Bluetooth services" \
      sudo systemctl enable --now $NEED_ENABLE
  else
    log_ok "NetworkManager & Bluetooth already enabled & active"
  fi
}

gui_boot() {
  CURRENT_TARGET=$(systemctl get-default)

  if [ "$CURRENT_TARGET" = "graphical.target" ]; then
    log_info "SKIP ===> Default target already graphical"
  else
    run "Set default target to graphical (GUI on boot)" \
      sudo systemctl set-default graphical.target
  fi
}

base_system() {
  install_packages "System update (dnf update)" \
    sudo dnf update -y

  rpm_fusion

  install_packages "Install GNOME core components" \
    sudo dnf install -y \
      gnome-shell \
      gdm \
      gnome-session \
      gnome-settings-daemon \
      gnome-control-center

  install_packages "Install GNOME utilities & file manager" \
    sudo dnf install -y \
      nautilus \
      gsettings-desktop-schemas

  install_packages "Install Xorg & graphics stack" \
    sudo dnf install -y \
      xorg-x11-server-Xorg \
      xorg-x11-xauth \
      xorg-x11-drivers \
      mesa-dri-drivers \
      mesa-libEGL \
      mesa-libGL

  install_packages "Install system services (DBus, Polkit, Network)" \
    sudo dnf install -y \
      dbus \
      polkit \
      NetworkManager

  install_packages "Install Bluetooth & audio (PipeWire)" \
    sudo dnf install -y \
      bluez \
      pipewire \
      pipewire-pulse \
      wireplumber

  if is_group_installed "multimedia"; then
    log_info "SKIP ===> Group multimedia already installed (skip)"
  else
    run "Install multimedia codecs (RPM Fusion)" \
      sudo dnf group install -y multimedia \
        --setopt=install_weak_deps=False \
        --exclude=PackageKit-gstreamer-plugin
  fi

  install_packages "Install basic utilities (terminal & monitor)" \
    sudo dnf install -y \
      alacritty \
      htop \
      bleachbit \
  
  if is_service_enabled gdm; then
    log_info "SKIP ===> GDM already enabled"
  else
    run "Enable GDM (GNOME Display Manager)" \
      sudo systemctl enable gdm --force
  fi
  
  gui_boot
  manager_bluetooth_network
}

dev_tools() {
  run "Add NodeSource repo (Node.js LTS)" \
    curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -

  install_packages "Install Node.js LTS (npm included)" \
    sudo dnf install -y nodejs

  install_packages "Install pnpm (global via npm)" \
    sudo npm install -g pnpm

  install_packages "Install PHP & common extensions" \
    sudo dnf install -y \
      php \
      php-cli \
      php-common \
      php-mbstring \
      php-pdo \
      php-mysqlnd \
      php-xml \
      php-curl \
      php-zip
  
  run "Install Composer (PHP dependency manager)" \
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" \
    && php composer-setup.php --install-dir=/usr/local/bin --filename=composer \
    && rm -f composer-setup.php

  if is_group_installed "development-tools"; then
    log_info "SKIP ===> Development tools already installed"
  else
    run "Install Development Tools group (gcc, make, etc)" \
      sudo dnf group install -y development-tools
  fi

  install_packages "Install low-level build dependencies" \
    sudo dnf install -y \
      openssl-devel \
      pkg-config \
      clang \
      kernel-devel \
      kernel-headers

  install_packages "Install Podman & Cockpit (container + web UI)" \
    sudo dnf install -y podman cockpit cockpit-podman

  if is_service_enabled cockpit.socket; then
    log_info "SKIP ===> Cockpit already enabled"
  else
    run "Enable Cockpit Web UI (port 9090)" \
      sudo systemctl enable --now cockpit.socket
  fi

  run "Install DBeaver (RPM direct)" \
    curl -L -o /tmp/dbeaver.rpm https://dbeaver.io/files/dbeaver-ce-latest.x86_64.rpm \
    && sudo dnf install -y /tmp/dbeaver.rpm \
    && rm -f /tmp/dbeaver.rpm

  run "Enable RPM Code" \
    sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc \
    && sudo tee /etc/yum.repos.d/vscode.repo << 'EOF'
[code]
name=Visual Studio Code
baseurl=https://packages.microsoft.com/yumrepos/vscode
enabled=1
gpgcheck=1
gpgkey=https://packages.microsoft.com/keys/microsoft.asc
EOF

  install_packages "Install Visual Studio Code" \
    sudo dnf install -y code

  install_packages "Install Postman & Mockoon (API tools)" \
    sudo dnf install -y postman mockoon
}

ms_edge() {
  run "Enable RPM Microsoft Edge" \
    sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
  
  run "Install Microsoft Edge" \
    sudo tee /etc/yum.repos.d/microsoft-edge.repo << 'EOF'
[microsoft-edge]
name=Microsoft Edge
baseurl=https://packages.microsoft.com/yumrepos/edge
enabled=1
gpgcheck=1
gpgkey=https://packages.microsoft.com/keys/microsoft.asc
EOF

  install_packages "Installing Microsoft Edge" \
    sudo dnf install microsoft-edge-stable
}

firefox() {
  install_packages "Installing Firefox" \
    sudo dnf install firefox
}

chrome() {
  install_packages "Installing Chrome" \
    sudo dnf install -y https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm
}

detect_fedora_variant
require_fedora_server

LOG_PATH=""
for arg in "$@"; do
  case "$arg" in 
    --base-system)
      base_system
      ;;
    --dev-tools)
      dev_tools
      ;;
    --ms-edge)
      ms_edge
      ;;
    --firefox)
      firefox
      ;;
    --chrome)
      chrome
      ;;
    --log)
      LOG_PATH="log/*.log"
      ;;
    --log=*)
      LOG_PATH="${arg#--log=}"
      ;;
    *)
      log_fail: "Unknown option: $arg"
      exit 1
      ;;
  esac
done

if [ -n "$LOG_PATH" ]; then
  log_info "Searching FAIL logs in: $LOG_PATH"
  grep -n '\[FAIL\]' $LOG_PATH || log_fail "[INFO] No FAIL found"
fi

echo ""
echo "================ INSTALL SUMMARY ================"
echo "OK     : $SUMMARY_OK"
echo "FAILED : $SUMMARY_FAIL"

if [ "$SUMMARY_FAIL" -ne 0 ]; then
  echo -e "${YELLOW}Failed steps:${RESET}"
  echo -e "$FAILED_STEPS"
  echo -e "${YELLOW}Check log file:${RESET} $LOG_FILE"
else
  echo -e "${GREEN}All steps completed successfully ðŸŽ‰${RESET}"
fi